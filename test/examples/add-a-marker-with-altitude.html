<!DOCTYPE html>
<html lang="en">
<head>
    <title>Add a altitude marker</title>
    <meta property="og:description" content="Add a default marker to the map." />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='../../dist/maplibre-gl.css' />
    <script src='../../dist/maplibre-gl-dev.js'></script>
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
    </style>
</head>
<body>
<div id="map"></div>
<div style="position: fixed;left: 5%;top: 5%">
    <div>
        <form>
            <fieldset>
                <legend>setProjectionï¼š</legend>
                <div>
                    <input type="radio" id="contactChoice1" name="contact" value="mercator" checked />
                    <label for="contactChoice1">mercator</label>
                    <input type="radio" id="contactChoice2" name="contact" value="globe" />
                    <label for="contactChoice2">globe</label>
                </div>
            </fieldset>
        </form>
    </div>
</div>

<script>
    const map = new maplibregl.Map({
        container: 'map',
        maxPitch:88,
        hash:true,
        style:
            'https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL',
        center: [12.550343, 55.665957],
        zoom: 8
    });

    let lngLatArr = [];
    const spinningMarkers = [];
    // type Alignment = 'map' | 'viewport' | 'auto';
    ['auto', 'map', 'viewport'].forEach((rotationAlignment, i) => {
        ['auto', 'map', 'viewport'].forEach((pitchAlignment, j) => {
            // if(!(i===2 && j===0))return
            const bounds = map.getBounds();
            const s = bounds.getSouth();
            const n = bounds.getNorth();
            const w = bounds.getWest();
            const e = bounds.getEast();
            const lng = w + (e - w) * ((i + .5) / 4);
            const lat = s + (n - s) * ((j + .5) / 3);
            const height = (i * 2000 + j*2000) * (e - w);

            const popupHtml = `<div>
                Pitch Alignment: ${pitchAlignment}<br>
                Rotation Alignment: ${rotationAlignment}<br>
                lng:${lng}<br>
                lat:${lat}<br>
                height(altitude):${height}<br>
              </div>`

            const popup = new maplibregl.Popup().setHTML(popupHtml);

            const r = Math.round(Math.random() * 255);
            const g = Math.round(Math.random() * 255);
            const b = Math.round(Math.random() * 255);

            const marker = new maplibregl.Marker({
                color: `rgb(${r}, ${g}, ${b})`,
                draggable: true,
                rotationAlignment,
                pitchAlignment,
                altitude:height,
            })
                .setLngLat([lng, lat])
                .setPopup(popup)
                .addTo(map);

            marker.togglePopup();

            lngLatArr.push({
                lngLat:[lng, lat],
                lngOffset:(e - w),
                latOffset:(n - s),
                height
            })

            spinningMarkers.push(marker);
        });
    });

    function addFillExtrusionLayer(data=[]){
        const dataArr = data.map(a=>{
            let {lngOffset,latOffset} = a;
            lngOffset = lngOffset/100;
            latOffset = latOffset/100;
            const [lng, lat] = a.lngLat;
            const aObj = {
                ...a,
                "type": "Feature",
                "properties": {
                    "height": a.height,
                    "color": `rgba(${a.height%255},${a.height%150},${255 - a.height%255},1)`,
                },
                lngLatArr:[
                    [lng-lngOffset,lat+latOffset],
                    [lng+lngOffset,lat+latOffset],
                    [lng+lngOffset,lat-latOffset],
                    [lng-lngOffset,lat-latOffset],
                ]
            }

            aObj.geometry = {
                "type": "Polygon",
                "coordinates": [aObj.lngLatArr]
            }

            return aObj
        });
        let layer = {
            id:'FillExtrusionLayerId',
            'type': 'fill-extrusion',
            'source': {
                type: 'geojson',
                data: {
                    "type": "FeatureCollection",
                    "features":dataArr,
                }
            },
            'paint': {
                'fill-extrusion-opacity':0.6,
                'fill-extrusion-color': ["get", "color"],
                'fill-extrusion-height': ["get", "height"],
                'fill-extrusion-base': 0,
            }
        }

        map.addLayer(layer);

    }
    map.on('style.load',()=>{
        addFillExtrusionLayer(lngLatArr);
    });

    const centerLngLat = map.getCenter();
    const defaultPopup = new maplibregl.Popup().setHTML(
        `<div>
                lng:${centerLngLat.lng}<br>
                lat:${centerLngLat.lat}<br>
              </div>`
    );
    const marker = new maplibregl.Marker({
        draggable: true,
    })
        .setLngLat([centerLngLat.lng, centerLngLat.lat])
        .setPopup(defaultPopup)
        .addTo(map);
    const form = document.querySelector("form");
    form.addEventListener('change',(e)=>{
        const value = e.target.value;
        if(value){
            map.setProjection({
                type: value,
            });
        }
    });
</script>
</body>
</html>
